<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日语红蓝宝书 · 千问提取+测验</title>
  <link rel="stylesheet" href="./css/styles.css" />
</head>
<body>
<header>
  <h1>日语红蓝宝书 · 千问提取+测验</h1>
  <p class="note">⚠️ 直接在浏览器里调用千问 API 会暴露密钥给本机浏览器（保存在本地存储）。仅在你自己的电脑上使用，勿在公共场所或托管环境使用。</p>
</header>

<section class="config">
  <h2>API 配置</h2>
  <div class="grid">
    <label>API Base
      <input id="apiBase" type="text" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" />
    </label>
    <label>模型（图像+文本）
      <input id="apiModel" type="text" value="qwen-vl-max" />
    </label>
    <label>API Key
      <input id="apiKey" type="password" placeholder="sk-..." />
    </label>
    <label class="checkbox">
      <input id="rememberKey" type="checkbox" />
      记住到本地（localStorage）
    </label>
  </div>
</section>

<section class="dataset">
  <h2>数据输入方式</h2>
  
  <!-- 选项卡切换 -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button id="tabImage" class="tab-btn active">图片提取</button>
      <button id="tabManual" class="tab-btn">手动输入</button>
    </div>
    
    <!-- 图片提取选项卡 -->
    <div id="panelImage" class="tab-panel active">
      <div class="grid">
        <label>页码（可选）
          <input id="pageNumber" type="number" min="1" step="1" placeholder="留空则自动检测" />
        </label>
        <label>上传图片（该页的拍照）
          <input id="pageImage" type="file" accept="image/*" />
        </label>
      </div>
      <div class="actions">
        <button id="btnExtract">从图片用千问提取词汇并保存</button>
        <span id="extractStatus" class="status"></span>
      </div>
    </div>
    
    <!-- 手动输入选项卡 -->
    <div id="panelManual" class="tab-panel">
      <div class="grid">
        <label>页码
          <input id="manualPageNumber" type="number" min="1" step="1" placeholder="例如 520" />
        </label>
        <label>JSON数据
          <textarea id="manualJson" placeholder="粘贴JSON格式的词汇数据..." rows="10"></textarea>
        </label>
      </div>
      <div class="actions">
        <button id="btnParseJson">解析JSON数据并保存</button>
        <button id="btnShowExample" class="secondary">查看JSON格式示例</button>
        <span id="parseStatus" class="status"></span>
      </div>
      <div id="jsonExample" class="hidden" style="margin-top: 16px; padding: 12px; background: #0f1630; border-radius: 8px; border: 1px solid #2b3a6b;">
        <h4 style="margin: 0 0 8px; color: var(--muted);">JSON格式示例：</h4>
        <pre style="margin: 0; color: var(--ink); font-family: ui-monospace, 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace; font-size: 12px; white-space: pre-wrap;">{
  "page": 520,
  "items": [
    {
      "jp": "勉強",
      "reading": "べんきょう",
      "pos": "名・サ変",
      "cn": "学习",
      "tag": "普通",
      "accent": ["0"]
    },
    {
      "jp": "頑張る",
      "reading": "がんばる",
      "pos": "動五",
      "cn": "努力",
      "tag": "关联",
      "accent": ["3"]
    }
  ]
}</pre>
      </div>
    </div>
  </div>

  <div class="grid">
    <label>已保存页码
      <select id="savedPages"></select>
    </label>
    <div class="actions-inline">
      <button id="btnLoadPage">载入所选页</button>
      <button id="btnDeletePage" class="danger">删除所选页</button>
    </div>
    <div id="pdfPreviewSection" class="pdf-preview hidden">
      <div id="pdfPreviewContainer" class="pdf-preview-container"></div>
      <span id="pdfPreviewInfo" class="pdf-preview-info"></span>
    </div>
    <label>上传参考 PDF
      <input id="pdfFileInput" type="file" accept="application/pdf" />
    </label>
  </div>
</section>

<section class="search">
  <h2>全局搜索</h2>
  <div class="actions">
    <input id="searchInput" type="text" placeholder="输入日语、读音或中文释义..." />
    <button id="btnSearch">搜索</button>
  </div>
</section>

<section class="words">
  <h2 id="wordSectionTitle">本页词汇</h2>
  <table id="wordTable">
    <thead>
      <tr>
        <th>#</th>
        <th>日文</th>
        <th>词性</th>
        <th>读音</th>
        <th>中文释义</th>
        <th>标签</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section class="quiz">
  <h2>测验</h2>
  <div class="actions">
    <button id="btnQuizSeq">1) 顺序考（问中文→答日文，附词性）</button>
    <button id="btnQuizShuffle">2) 乱序考（问中文→答日文，附词性）</button>
    <button id="btnQuizReading">3) 乱序考（问日文→答假名读音）</button>
    <button id="btnQuizFuzzy">4) 乱序考（问日文→答中文，模糊判定）</button>
  </div>

  <!-- 考试历史记录区域 -->
  <div class="exam-history">
    <h3>考试历史</h3>
    <div id="examHistoryList" class="exam-history-list">
      <div class="no-history">暂无考试记录</div>
    </div>
  </div>

  <div id="quizPanel" class="quiz-panel hidden">
    <div class="quiz-results">
      <h3>答题记录</h3>
      <div id="quizHistory" class="quiz-history"></div>
    </div>

    <div class="quiz-header">
      <div class="quiz-row">
        <div id="quizProgress"></div>
        <div id="quizMode"></div>
      </div>
    </div>
    
    <div class="quiz-content">
      <div class="quiz-q">
        <div id="quizQuestion"></div>
        <div id="quizHint" class="hint"></div>
      </div>
      <div id="quizResult" class="result"></div>
    </div>
    
    <div class="quiz-footer">
      <div id="quizControls" style="display: block;">
        <div class="quiz-a">
          <input id="quizAnswer" type="text" placeholder="在此作答…" />
          <button id="btnSubmitAnswer">提交</button>
          <button id="btnSkip">跳过</button>
        </div>
        <button id="btnEndQuiz" class="secondary">结束测验</button>
      </div>
      <div id="quizPostGradingControls" style="display: none;">
        <button id="btnCloseQuiz" class="primary">查看完毕，关闭面板</button>
      </div>
    </div>
  </div>
</section>

<footer>
  <p>Made for your workflow · 数据保存在浏览器本地（localStorage）。</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";
  }
</script>
<script type="module" src="./js/app.js"></script>

<div id="pdfModal" class="pdf-modal hidden">
  <div class="pdf-modal-backdrop" data-close-pdf-modal></div>
  <div class="pdf-modal-content">
    <button class="pdf-modal-close" data-close-pdf-modal>&times;</button>
    <div class="pdf-modal-resize-handle pdf-modal-resize-handle-nw" data-resize-corner="nw"></div>
    <div class="pdf-modal-resize-handle pdf-modal-resize-handle-ne" data-resize-corner="ne"></div>
    <div class="pdf-modal-resize-handle pdf-modal-resize-handle-sw" data-resize-corner="sw"></div>
    <div class="pdf-modal-resize-handle pdf-modal-resize-handle-se" data-resize-corner="se"></div>
    <div id="pdfModalViewer" class="pdf-modal-viewer">
      <div class="pdf-modal-canvas-wrapper">
        <canvas id="pdfModalCanvas"></canvas>
        <div id="pdfModalTextLayer" class="textLayer"></div>
      </div>
      <div id="pdfModalLoading" class="pdf-modal-loading hidden">正在加载…</div>
    </div>
  </div>
</div>
</body>
</html>
